(()=>{"use strict";const e=window.wp.blocks,t=window.wp.hooks,n=window.wp.element,a=window.wp.i18n,o=window.wp.blockEditor,r=window.wp.components,i=wp.data.select("core/block-editor"),l=wp.data.dispatch("core/block-editor"),c=i.getBlock,s=i.getBlockIndex,d=l.insertBlock,u=l.updateBlockAttributes,p=(l.updateBlock,i.getBlockRootClientId),m=(l.insertAfterBlock,l.insertBeforeBlock,l.removeBlocks),g=l.removeBlock,f=wp.blocks.switchToBlockType,w=wp.blocks.createBlock,h=wp.data.dispatch("core/notices").createErrorNotice,y=["core/paragraph","core/heading","core/group","core/code","core/pullquote","core/quote","core/verse","core/list","core/list-item"],b=e=>{m(c(e).innerBlocks.map((e=>e.clientId)))},v=e=>(e=(e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>')).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")).replace(/\*(.*?)\*/g,"<em>$1</em>"),k=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};switch(e){case"core/quote":case"core/pullquote":var a=t.split(" - ");a.length>1&&(n.citation=a.pop(),t=a.join(" - ")),n.value=v(t);break;default:n.content=v(t)}return w(e,n)},E=async(e,t,n,a)=>{var o=k(e,t.trimStart(),a);const r=c(n);r.innerBlocks;var i=r.innerBlocks?r.innerBlocks.length:0;return await d(o,i,n),await c(n).innerBlocks[i]},C=/^(\d+\.|\*|\-)\s/,_=e=>C.test(e),B=e=>e.replace(C,""),x=e=>/^\d+\./.test(e),S=e=>{let{idBlock:t,prompt:n,context:o,keywords:r,edit:i,setAttributes:l,insertAfter:m,onDone:y,isTiny:C=null,injectContent:S=null}=e;if(null==n)return;var M=new FormData;M.append("action","open_ai");const{style:A,tone:I,language:N,maxWords:T,nonce:$}=window.aiify;M.append("openai_nonce",$),M.append("style",A),M.append("tone",I),M.append("language",N),M.append("maxWords",T),i&&M.append("edit",i),M.append("prompt",n),o&&M.append("context",o),r&&M.append("keywords",r);var F=new URLSearchParams(M).toString(),P=new EventSource(window.ajaxurl+"?"+F),D=C?null:c(t),q=C?null:"core/group"==D.name||"core/list"==D.name,j="",G={},H=!1,O=!1,R=!1,W=!1,L="core/paragraph",Z="",J=t,z=!0,U=!0,V=!1,K=!1,Q=!1,X=!1,Y=!1,ee=null;const te="after"==m;var ne=!0,ae="",oe=!1;const re=()=>{console.log("Answer completed",j),y&&y()};P.onmessage=async function(e){if(ne){ne=!1;const t=JSON.parse(e.data);if("messages"in t){var n=t.messages.map((e=>e.content)).join("\n\n");window.aiify.latestPrompt=n}return"prompt"in t&&(console.log("Prompt",t.prompt),window.aiify.latestPrompt=t.prompt),void("error"in t&&h(t.error.message,{type:"snackbar",explicitDismiss:!0}))}if("[DONE]"==e.data){if(P.close(),m)g(ee.innerBlocks[0].clientId);else if(i)return"core/paragraph"!==L&&f(c(J),L),u(J,{content:v(Z.trimStart()),name}),void re();return C?S(L,v(Z),G):E(L,Z,J,G),void re()}var o="";try{var r=JSON.parse(e.data);if("finish_reason"in r.choices[0]&&"length"==r.choices[0].finish_reason&&h((0,a.__)("Response stopped due to length limitation","aiify"),{type:"snackbar",explicitDismiss:!0}),"text"in r.choices[0])o=r.choices[0].text;else{if(!("content"in r.choices[0].delta))return;o=r.choices[0].delta.content}}catch(e){return}if(j+=o,!z||(z=!1,"\n\n"!=o&&""!=o)){if(i)if(m)0==Y&&(ee=await async function(e,t,n,o){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};var i=null;if("core/group"==e){const t=w("core/paragraph",{content:(0,a.__)("Please wait...","aiify")});i=w(e,{layout:{type:"constrained"},tagName:"div"},[t])}else if(t&&_(t)){e="core/list";var l=t.split("\n").map((e=>w("core/list-item",{content:B(t)})));i=w(e,{ordered:x(t)},l)}else i=k(e,t.trimStart(),r);var c=s(n),u=p(n);return console.log("Block index  ",n,c),await d(i,o?c+1:c,u),i}("core/group",null,J,te),J=t=ee.clientId,Y=!0);else{if(!q)return"##"==o.slice(0,2)?(L="core/heading",void(G={level:o.length})):void(Z+=o);0==X&&(b(t),X=!0)}if(0==H){if("\n"==(o=`${ae}${o}`).slice(0,1)||"\n"==o.slice(0,2))return void console.log("skiped not started :"+o);if(H=!0,G={},">"==o.slice(0,1)||"&gt;"==o.slice(0,4))L="core/pullquote",J=t,Q=!0,K=!1,W=!1;else if("##"==o.slice(0,2)||" ##"==o.slice(0,3))L="core/heading",J=t,K=!0,W=!1,Q=!1,G={level:o.trim("").length},console.log("startHeading");else if(_(o))0==W&&(W=!0,oe=x(o),console.log("IS ordered",o,oe),null==C&&(R=await E("core/list","",J,{ordered:oe}),J=R.clientId),U=!0),console.log("Cleaning operator : "+o),o=B(o),console.log("Cleaned operator : "+o),V=!0,K=!1,Q=!1,ae="",L="core/list-item";else{if((e=>/^(\d+\.|\d+|\*|\-)/.test(e))(o))return ae=o,void(H=!1);L="core/paragraph",ae="",J=t,W=!1,K=!1,Q=!1}}else"\n\n"!=o.slice(-2)&&"\n"!=o.slice(-1)||(O=!0);if(V||K||Q?(V&&(Z+=o),V=!1,K=!1,Q=!1):Z+=o,O){if(W&&U){if(C){var y={first:!0,ordered:oe};console.log(L,y),S(L,v(Z.trimStart()),y)}else c(R.clientId).innerBlocks[0].attributes.content=v(Z.trimStart());U=!1}else C?S(L,v(Z.trimStart()),G):await E(L,Z,J,G);Z="",O=!1,H=!1}l({reply:j})}},P.onerror=function(e){h((0,a.__)("Error while calling the AI Engine","aiify"),{type:"snackbar",explicitDismiss:!0}),P.close(),re()}},M=(0,n.createElement)("svg",{id:"Layer_1","data-name":"Layer 1",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 553.84 552.02"},(0,n.createElement)("path",{fill:"#6f52a2",d:"M.67,.18H371.96c99.34,0,180,80.66,180,180v371.29H180.67C81.32,551.47,.67,470.82,.67,371.47V.18H.67Z"}),(0,n.createElement)("g",null,(0,n.createElement)("path",{fill:"#fff",d:"M243.54,394.07c-23.45,0-43.15-8.03-59.11-24.1-15.96-16.07-23.94-35.83-23.94-59.28s7.98-43.15,23.94-59.11c15.96-15.96,35.66-23.94,59.11-23.94s43.2,7.98,59.28,23.94c16.06,15.96,24.1,35.66,24.1,59.11v60.9c0,6.52-2.07,11.78-6.19,15.8-4.13,4.01-9.45,6.02-15.96,6.02s-11.78-2.01-15.8-6.02c-4.02-4.02-6.02-9.28-6.02-15.8v-60.9c0-10.85-3.86-20.08-11.56-27.68-7.71-7.6-16.99-11.4-27.85-11.4s-20.08,3.8-27.68,11.4c-7.6,7.61-11.4,16.83-11.4,27.68s3.8,20.14,11.4,27.85c7.6,7.71,16.82,11.56,27.68,11.56,6.51,0,11.83,2.01,15.96,6.03,4.12,4.02,6.19,9.28,6.19,15.79s-2.07,11.84-6.19,15.96c-4.13,4.13-9.45,6.19-15.96,6.19Z"}),(0,n.createElement)("path",{fill:"#fff",d:"M385.37,165.93c5.32,5.33,7.98,11.68,7.98,19.06s-2.66,13.74-7.98,19.05c-5.32,5.32-11.67,7.98-19.05,7.98s-13.74-2.66-19.05-7.98c-5.32-5.32-7.98-11.67-7.98-19.05s2.66-13.73,7.98-19.06c5.32-5.32,11.67-7.98,19.05-7.98s13.73,2.66,19.05,7.98Zm3.09,83.54c0-14.54-7.38-21.82-22.15-21.82-6.52,0-11.78,2.01-15.8,6.02-4.02,4.02-6.03,9.28-6.03,15.79v122.13c0,6.52,2.01,11.78,6.03,15.8,4.01,4.01,9.28,6.02,15.8,6.02s11.83-2.01,15.96-6.02c4.12-4.02,6.19-9.28,6.19-15.8v-122.13Z"}))),A=(0,n.createElement)("svg",{width:"135",height:"140",viewBox:"0 0 135 140",xmlns:"http://www.w3.org/2000/svg",fill:"#fff"},(0,n.createElement)("rect",{y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"30",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"60",width:"15",height:"140",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"90",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.25s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.25s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"})),(0,n.createElement)("rect",{x:"120",y:"10",width:"15",height:"120",rx:"6"},(0,n.createElement)("animate",{attributeName:"height",begin:"0.5s",dur:"1s",values:"120;110;100;90;80;70;60;50;40;140;120",calcMode:"linear",repeatCount:"indefinite"}),(0,n.createElement)("animate",{attributeName:"y",begin:"0.5s",dur:"1s",values:"10;15;20;25;30;35;40;45;50;0;10",calcMode:"linear",repeatCount:"indefinite"}))),I="aiify/aiify",N=window.wp.compose,T=e=>{const{styles:t,tones:o,maxWords:i,style:l,tone:c,languages:s,language:d,latestPrompt:u}=window.aiify,[p,m]=(0,n.useState)(parseInt(i)),[g,f]=(0,n.useState)(c),[w,h]=(0,n.useState)(l),[y,b]=(0,n.useState)(d);return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(r.RangeControl,{min:0,max:2e3,label:(0,a.__)("Max words to generate","aiify"),help:(0,a.__)("Do not exceed this value","aiify"),value:parseInt(p),onChange:e=>{window.aiify.maxWords=e,m(e)}}),(0,n.createElement)(r.SelectControl,{label:(0,a.__)("Select writing style","aiify"),onChange:e=>{window.aiify.style=e,h(e)},options:t,value:w}),(0,n.createElement)(r.SelectControl,{label:(0,a.__)("Select writing tone","aiify"),onChange:e=>{window.aiify.tone=e,f(e)},options:o,value:g}),(0,n.createElement)(r.SelectControl,{label:(0,a.__)("Select an output language","aiify"),onChange:e=>{window.aiify.language=e,b(e)},options:s,value:y}))},$=(0,N.createHigherOrderComponent)((e=>t=>{const{name:i,attributes:l,setAttributes:c}=t;if((e=>y.concat(["aiify/aiify"]).includes(e))(i)&&t.isSelected){const{latestPrompt:i}=window.aiify;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(e,t),(0,n.createElement)(o.InspectorControls,null,(0,n.createElement)(r.PanelBody,{icon:M,title:(0,a.__)("Aiify Settings","aiify")},(0,n.createElement)(T,t),(0,n.createElement)(r.TextareaControl,{label:(0,a.__)("Last Prompt","aiify"),rows:10,value:i,disabled:!0}))))}return(0,n.createElement)(e,t)}),"withPanelControl"),F=(window.wp.data,wp.data.select("core/block-editor").getSelectedBlock),P=e=>{const{attributes:t,name:n,innerBlocks:a=[]}=e,{content:o,level:r}=t||{};if(o)switch(n){case"core/heading":return`${"#".repeat(r)} ${o.replace(/\n+$/,"")}\n`;case"core/list-item":return`- ${o}\n`;case"core/citation":case"core/pullquote":return`> ${o}\n\n`;case"core/code":case"core/verse":return`\`\`\`\n${o}\n\`\`\`\n\n`;default:return`${o}\n`}return a.map(P).join("")},D=(0,N.createHigherOrderComponent)((e=>i=>{if(!y.includes(i.name))return(0,n.createElement)(e,i);const[l,c]=(0,n.useState)(!1),[s,d]=(0,n.useState)(!1),[u,p]=(0,n.useState)([]),m=()=>c(!1),g=async(e,t,n)=>{if(void 0===n&&(n=F()),n){d(!0);const a=P(n);S({idBlock:n.clientId,edit:a,prompt:e,setAttributes:()=>console.log,insertAfter:"edit"==t?null:t,onDone:()=>d(!1)})}},f=e=>{let{edits:t,command:o,onClose:i}=e;var l=[];return t.forEach((function(e){l.push({title:e,onClick:t=>{g(e,o),t()}})})),l.push({title:(0,a.__)("Custom edit","aiify"),onClick:e=>{p([o,F()]),c(!0),e()}}),(0,n.createElement)(n.Fragment,null,l.map((e=>(0,n.createElement)(r.MenuItem,{onClick:()=>e.onClick(i)},e.title))))},{attributes:w,setAttributes:h}=i,{edits:b,after:v,before:k}=window.aiify,E=(0,t.applyFilters)("aiify.customModal",(e=>(0,n.createElement)(n.Fragment,null,(0,n.createElement)("p",null,"Decouvrez la version pro"))));return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(o.BlockControls,{group:"block"},(0,n.createElement)(r.ToolbarGroup,null,(0,n.createElement)(r.ToolbarDropdownMenu,{icon:s?A:M,label:(0,a.__)("Aiify me","aiify")},(e=>{let{onClose:t}=e;return(0,n.createElement)(n.Fragment,null,(0,n.createElement)(r.MenuGroup,{label:(0,a.__)("Review or edit this block","aiify")},(0,n.createElement)(f,{edits:b,command:"edit",onClose:t})),(0,n.createElement)(r.MenuGroup,{label:(0,a.__)("Generate and prepend based on this block","aiify")},(0,n.createElement)(f,{edits:k,command:"before",onClose:t})),(0,n.createElement)(r.MenuGroup,{label:(0,a.__)("Generate and append based on this block","aiify")},(0,n.createElement)(f,{edits:v,command:"after",onClose:t})))})))),l&&(0,n.createElement)(r.Modal,{title:(0,a.__)("Custom command","aiify"),onRequestClose:m},(0,n.createElement)(E,{generateBlock:g,selectedEdit:u,closeModal:m})),(0,n.createElement)(e,i))}),"withToolbarButton");(0,e.registerBlockType)(I,{icon:{src:M},edit:function(e){let{attributes:t,setAttributes:i,isTiny:l=null,injectContent:c=null,onDone:s=(()=>null)}=e;return function(e){const t=l?[]:(0,o.useBlockProps)(),[d,u]=(0,n.useState)(!1),{prompts:p}=window.aiify;if(l){var[e,m]=(0,n.useState)({});i=t=>{m({...e,...t})}}var g=l||t.id.split("block-")[1];const f="prompt-"+g,w="context-"+g,h="keywords-"+g,y=l?null:(0,n.createElement)(o.InnerBlocks,{allowedBlocks:["core/image","core/group","core/paragraph","core/quote","core/code","core/pullquote","core/list","core/list-item","core/heading","core/verse","wp-gb/inner-blocks"]}),v=l?null:(0,n.createElement)(r.Button,{disabled:d,variant:"default",onClick:()=>b(g),text:(0,a.__)("Clear","aiify")});return(0,n.createElement)("div",t,(0,n.createElement)(r.SelectControl,{label:(0,a.__)("Select a content type","aiify"),onChange:e=>{const t=e+' "['+p[e]+']"';i({prompt:t});const n=document.querySelector('[data-id="'+f+'"]');n&&setTimeout((()=>n.focus()),200),console.log()},options:(k=p,Object.keys(k).map(((e,t,n)=>({label:e,value:n[t]}))))}),(0,n.createElement)(r.TextareaControl,{"data-id":f,autoFocus:!0,placeholder:(0,a.__)("What do you want to write today?","aiify"),label:"",rows:2,value:e.prompt,onChange:e=>i({prompt:e}),onFocus:e=>{const t=e.target,n=t.value.match(/\"\[([^\]]+)\]\"/);if(n){const e=n.index+1,a=e+n[1].length+2;t.selectionStart=e,t.selectionEnd=a}}}),(0,n.createElement)(r.TextareaControl,{"data-id":w,placeholder:(0,a.__)("Add key information to include in the content?\n- Information 1\n- Information 2","aiify"),label:"",rows:4,value:e.context,onChange:e=>i({context:e})}),(0,n.createElement)(r.TextareaControl,{"data-id":h,placeholder:(0,a.__)("Add keywords to highlight in the content? (comma separated keywords)","aiify"),label:"",rows:1,value:e.keywords,onChange:e=>i({keywords:e})}),(0,n.createElement)(r.ButtonGroup,{textAlign:"right"},(0,n.createElement)(r.Button,{isBusy:d,disabled:d||null==e.prompt,variant:"primary",onClick:()=>{u(!0),S({prompt:e.prompt,context:e.context,keywords:e.keywords,idBlock:g,setAttributes:i,onDone:()=>{u(!1),s()},isTiny:l,injectContent:c})},text:(0,a.__)("Write","aiify")}),v),y);var k}(t)},save:function(e){let{attributes:t}=e;return(0,n.createElement)("div",o.useBlockProps.save(),(0,n.createElement)(o.InnerBlocks.Content,null))},transforms:{from:[{type:"enter",regExp:/^ai$/i,transform:()=>w(I)}],to:[{type:"block",blocks:["core/group"],transform:(e,t)=>w("core/group",e,t)}]}}),(0,t.addFilter)("editor.BlockEdit","ai-panel",$),(0,t.addFilter)("editor.BlockEdit","ai-toolbar",D),(0,t.addFilter)("blocks.getBlockAttributes","paragraph_prompt",((e,t)=>("core/paragraph"==t.name&&(e.placeholder=window.aiify.paragraphPrompt),e)))})();